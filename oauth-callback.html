<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Logging in...</title>
</head>
<body style="background: #0f0f0f; color: white; text-align: center; padding-top: 100px;">
  <h2>Logging in...</h2>
  <script>
    const accessToken = window.location.hash.split('&')[0].split('=')[1];

    fetch('https://discord.com/api/users/@me', {
      headers: {
        Authorization: `Bearer ${accessToken}`
      }
    })
    .then(res => res.json())
    .then(user => {
      localStorage.setItem('discordUser', JSON.stringify(user));

      return fetch('https://discord.com/api/users/@me/guilds', {
        headers: { Authorization: `Bearer ${accessToken}` }
      });
    })
    .then(res => res.json())
    .then(guilds => {
      const inPoppyPooperz = guilds.some(g => g.id === '1391923229249114112');
      if (!inPoppyPooperz) {
        alert("You are not in the Poppy Pooperz Discord server!");
        window.location.href = "/";
      } else {
        window.location.href = "/"; // back to home page
      }
    })
    .catch(err => {
      console.error(err);
      alert("Login failed");
      window.location.href = "/";
    });
  </script>
</body>
</html>
