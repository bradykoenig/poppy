<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Logging in...</title>
</head>
<body style="background: #0f0f0f; color: white; text-align: center; padding-top: 100px;">
  <h2>Logging in...</h2>

  <script>
    const params = new URLSearchParams(window.location.search);
    const code = params.get("code");

    if (!code) {
      alert("Login failed: No authorization code found.");
      window.location.href = "/home.html";
    }

    fetch("https://us-central1-poppy-d5573.cloudfunctions.net/exchangeCode", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ code })
    })
    .then(res => res.json())
    .then(data => {
    console.log("Received from backend:", data);

    // DEBUGGING: print raw object keys
    console.log("Keys in response:", Object.keys(data));

    const { access_token, user, guilds } = data;

    // Log each individually
    console.log("access_token:", access_token);
    console.log("user:", user);
    console.log("guilds:", guilds);

    if (!access_token || !user || !guilds) {
        throw new Error("Missing required data from backend.");
    }

      localStorage.setItem("discordUser", JSON.stringify(user));

      const inPoppyPooperz = Array.isArray(guilds) &&
        guilds.some(g => g.id === "1391923229249114112");

      if (!inPoppyPooperz) {
        alert("You are not in the Poppy Pooperz Discord server!");
        window.location.href = "/";
        return;
      }

      window.location.href = "/";
    })
    .catch(err => {
      console.error("OAuth callback error:", err);
      alert("Login failed");
      window.location.href = "/";
    });
  </script>
</body>
</html>
